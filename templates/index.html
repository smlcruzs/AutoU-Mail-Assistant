{% extends "base.html" %}
{% block content %}
<div class="grid md:grid-cols-2 gap-6 items-start">
  <section class="bg-white rounded-2xl shadow p-5">
    <h2 class="text-lg font-semibold mb-3">1) Envie o email</h2>
    <form id="email-form" class="space-y-4" enctype="multipart/form-data">
      <div>
        <label class="block text-sm font-medium">Cole o texto do email</label>
        <textarea name="email_text" id="email_text" rows="8" class="mt-1 w-full border rounded-lg p-3 focus:outline-none focus:ring" placeholder="Cole aqui o conteúdo do e-mail..."></textarea>
      </div>
      <div class="flex items-center gap-3">
        <div class="shrink-0 text-sm text-slate-500">ou</div>
        <div>
          <label class="block text-sm font-medium">Anexe um arquivo (.txt ou .pdf)</label>
          <input type="file" name="email_file" id="email_file" accept=".txt,.pdf" class="mt-1 block w-full text-sm">
        </div>
      </div>
      <p class="text-xs text-slate-500">Dica: se ambos forem enviados, o texto colado tem prioridade.</p>
      <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Classificar & Sugerir</button>
    </form>
    <div id="progress" class="hidden mt-4 text-sm text-slate-600">Processando…</div>
  </section>

  <section class="bg-white rounded-2xl shadow p-5">
    <h2 class="text-lg font-semibold mb-3">2) Resultado</h2>
    <div id="result" class="space-y-3">
      <div class="text-sm text-slate-500">Envie um e-mail para ver a classificação e a resposta sugerida.</div>
    </div>
  </section>
</div>

<script>
const form = document.getElementById('email-form');
const progressEl = document.getElementById('progress');
const resultEl = document.getElementById('result');

function pill(text, positive) {
  const color = positive ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-800';
  return `<span class="inline-block px-2 py-0.5 text-xs rounded-full ${color}">${text}</span>`;
}

function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  progressEl.classList.remove('hidden');
  resultEl.innerHTML = '';

  const fd = new FormData(form);
  try {
    const resp = await fetch('/process', { method: 'POST', body: fd });
    const data = await resp.json();
    if (!resp.ok) {
      throw new Error(data.erro || 'Falha ao processar');
    }
    const cat = data.categoria || '—';
    const ok = cat.toLowerCase().startsWith('produt');
    const resposta = data.resposta ? escapeHtml(data.resposta) : '';
    const origem = data.origem || '—';
    const justificativa = data.justificativa || '';

    resultEl.innerHTML = `
      <div class="flex items-center gap-2">
        <div class="text-sm">Categoria:</div>
        ${pill(cat, ok)}
        <div class="ml-auto text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">Origem: ${origem}</div>
      </div>
      <div class="text-sm text-slate-600"><strong>Justificativa:</strong> ${escapeHtml(justificativa)}</div>
      <div class="mt-3">
        <label class="block text-sm font-medium mb-1">Resposta sugerida</label>
        <div class="relative">
          <textarea id="replyBox" rows="6" class="w-full border rounded-lg p-3 focus:outline-none focus:ring">${resposta}</textarea>
          <button id="copyBtn" type="button" class="absolute top-2 right-2 text-xs bg-slate-800 text-white px-2 py-1 rounded-md">Copiar</button>
        </div>
      </div>
    `;

    const copyBtn = document.getElementById('copyBtn');
    const replyBox = document.getElementById('replyBox');
    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(replyBox.value);
        copyBtn.textContent = 'Copiado!';
        setTimeout(() => copyBtn.textContent = 'Copiar', 1200);
      } catch (err) {}
    });

  } catch (err) {
    resultEl.innerHTML = `<div class="text-red-600 text-sm">Erro: ${escapeHtml(String(err))}</div>`;
  } finally {
    progressEl.classList.add('hidden');
  }
});
</script>
{% endblock %}
